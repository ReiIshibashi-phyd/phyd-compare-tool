# CSV比較ツール 仕様書

## 1. 概要

### 1.1 目的
S3バケット内の2つのPrefix間でCSVファイルを比較し、差分を検出・レポートするツール

### 1.2 対象ユーザー
- データ分析担当者
- データ品質管理担当者
- システム運用担当者

### 1.3 実行環境
- Python 3.8以上
- Jupyter Notebook
- AWS S3アクセス権限

---

## 2. 機能仕様

### 2.1 主要機能

#### 2.1.1 ファイル比較機能
- **機能**: S3上の2つのPrefix間で同名のCSVファイルを自動検出し比較
- **入力**: S3バケット名、PrefixA（比較元）、PrefixB（比較先）
- **出力**: 差分レポート（CSV形式）、ID別詳細差分（画面表示）

#### 2.1.2 差分検出機能
- **ADDED**: PrefixBに新規追加された行
- **DELETED**: PrefixAから削除された行
- **MODIFIED**: 値が変更された項目

#### 2.1.3 キー列による突合
- 単一キー列対応
- 複数キー列対応（カンマ区切りで指定）
- キー列の自動結合処理

#### 2.1.4 無視列機能
- 比較対象から除外する列を指定可能
- 更新日時など変更が想定される列を除外

#### 2.1.6 ヘッダー有無対応
- ヘッダーありのCSV：列名で指定
- ヘッダーなしのCSV：列番号（0始まり）で指定
- ファイルごとに設定可能

#### 2.1.7 ファイル名パターンマッチング
- 正規表現による柔軟なファイル名マッチング
- ワイルドカード対応
- 日付パターンなどに対応
- メモリ閾値による自動判定
- チャンク処理による段階的読み込み
- ガベージコレクションによるメモリ管理

---

## 3. 設定仕様

### 3.1 S3設定

| 設定項目 | 型 | 必須 | 説明 | 例 |
|---------|-----|------|------|-----|
| S3_BUCKET | string | ✓ | S3バケット名 | `k-ishibashi-test` |
| S3_PREFIX_A | string | ✓ | 比較元Prefix | `data/before/` |
| S3_PREFIX_B | string | ✓ | 比較先Prefix | `data/after/` |
| S3_OUTPUT_PREFIX | string | ✓ | 出力先Prefix | `output/` |

### 3.2 処理設定

| 設定項目 | 型 | デフォルト | 説明 |
|---------|-----|-----------|------|
| CHUNK_SIZE | int | 10000 | チャンクサイズ（行数） |
| MEMORY_THRESHOLD_MB | int | 100 | メモリ閾値（MB） |

### 3.3 ファイル別設定

**設定形式**:
```python
FILE_SETTINGS = [
    {
        'pattern': r'正規表現パターン',  # ファイル名マッチングパターン
        'has_header': True/False,        # ヘッダー有無
        'key_columns': ['列名'] or [0],  # キー列（列名または列番号）
        'ignore_columns': ['列名'] or [0] # 無視列（列名または列番号）
    }
]
```

**設定項目**:

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| pattern | string | ✓ | ファイル名マッチング用の正規表現 |
| has_header | boolean | ✓ | ヘッダー行の有無（True/False） |
| key_columns | list | ✓ | キー列（ヘッダーありは列名、なしは列番号） |
| ignore_columns | list | | 無視列（ヘッダーありは列名、なしは列番号） |

**設定例**:

```python
FILE_SETTINGS = [
    # ヘッダーありのファイル（列名で指定）
    {
        'pattern': r'tccontract.*\.csv$',  # tccontractで始まる全CSVファイル
        'has_header': True,
        'key_columns': ['vin'],            # 列名で指定
        'ignore_columns': ['diffflag']
    },
    # ヘッダーなしのファイル（列番号で指定）
    {
        'pattern': r'noheader_\d{8}\.csv$',  # noheader_20251217.csv等
        'has_header': False,
        'key_columns': [0, 1],             # 0列目と1列目をキーに
        'ignore_columns': [5, 6]           # 5列目と6列目を無視
    },
    # 複数キー列の例
    {
        'pattern': r'sample\.csv$',
        'has_header': True,
        'key_columns': ['id', 'date'],     # 複数キー列
        'ignore_columns': ['updated_at']
    }
]
```

**正規表現パターン例**:

| パターン | マッチ例 | 説明 |
|---------|---------|------|
| `r'sample\.csv$'` | `sample.csv` | 完全一致 |
| `r'tccontract.*\.csv$'` | `tccontract_20251217.csv` | 前方一致 |
| `r'data_\d{8}\.csv$'` | `data_20251217.csv` | 8桁の日付を含む |
| `r'.*\.csv$'` | 全てのCSVファイル | 全てにマッチ |

---

## 4. 入出力仕様

### 4.1 入力

#### 4.1.1 CSVファイル
- **配置場所**: `s3://{bucket}/{prefix_a}/` および `s3://{bucket}/{prefix_b}/`
- **ファイル形式**: CSV（UTF-8エンコーディング）
- **ファイル名**: 完全一致するファイル名のみ比較対象
- **必須列**: 設定で指定したキー列が存在すること

### 4.2 出力

#### 4.2.1 差分レポート（CSV）
- **出力先**: `s3://{bucket}/{output_prefix}/{ファイル名}_diff_{タイムスタンプ}.csv`
- **ファイル名形式**: `{元ファイル名}_diff_YYYYMMDD_HHMMSS.csv`
- **エンコーディング**: UTF-8 with BOM

**カラム構成**:
| カラム名 | 型 | 説明 |
|---------|-----|------|
| key | string | キー値（複数キーの場合は結合） |
| diff_type | string | 差分タイプ（ADDED/DELETED/MODIFIED） |
| column | string | 変更された列名（MODIFIED時のみ） |
| baseline_value | any | PrefixAの値 |
| candidate_value | any | PrefixBの値 |

#### 4.2.2 ID別詳細差分レポート（画面表示）
```
vin: PHY0620-0012225
========================================
(現) 2025-12-17, nan, nan, nan, nan
(新) 2025-12-17, nan, test, nan, nan
変更された項目: contractstartdatetime
```

---

## 5. 処理フロー

### 5.1 全体フロー
```
1. 設定読み込み
2. S3クライアント作成
3. ファイル一覧取得（PrefixA、PrefixB）
4. 共通ファイル抽出
5. 各ファイルに対して:
   5.1 ファイルサイズ確認
   5.2 比較処理実行
   5.3 差分レポート生成
   5.4 ID別詳細差分表示
   5.5 S3に出力
6. 結果サマリー表示
```

### 5.2 比較処理フロー
```
1. CSVファイル読み込み（PrefixA、PrefixB）
2. キー列によるインデックス作成
3. 削除行検出（PrefixAのみに存在）
4. 追加行検出（PrefixBのみに存在）
5. 共通行の詳細比較
   5.1 各列の値を比較
   5.2 差分がある場合、レコード追加
6. 差分DataFrameを返却
```

---

## 6. エラーハンドリング

### 6.1 エラー種別

| エラー種別 | 原因 | 対処方法 |
|-----------|------|---------|
| S3アクセスエラー | 認証情報不正、権限不足 | AWS認証情報を確認 |
| ファイル読み込みエラー | ファイル不存在、形式不正 | S3パスとファイル形式を確認 |
| キー列不存在エラー | 指定したキー列が存在しない | 設定のキー列名を確認 |
| メモリ不足エラー | ファイルサイズが大きすぎる | CHUNK_SIZEを小さくする |

### 6.2 エラーメッセージ

```python
# S3エラー
"S3エラー: {エラー詳細}"

# 読み込みエラー
"読み込みエラー ({key}): {エラー詳細}"

# アップロードエラー
"アップロードエラー ({key}): {エラー詳細}"

# キー列エラー
"KeyError: None of ['列名'] are in the columns"
```

---

## 7. パフォーマンス仕様

### 7.1 処理性能

| 項目 | 仕様 |
|------|------|
| 小規模ファイル（<100MB） | 通常処理（一括読み込み） |
| 大規模ファイル（≥100MB） | チャンク処理（段階的読み込み） |
| 推奨チャンクサイズ | 10,000行 |
| 推奨メモリ閾値 | 100MB |

### 7.2 制約事項

| 項目 | 制約 |
|------|------|
| ファイルエンコーディング | UTF-8のみ対応 |
| ファイル名マッチング | 完全一致のみ |
| S3リージョン | AWS設定に依存 |
| 同時処理 | 順次処理（並列処理未対応） |

---

## 8. セキュリティ仕様

### 8.1 IAM権限要件

**最小権限ポリシー**:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::bucket-name",
        "arn:aws:s3:::bucket-name/data/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": ["s3:PutObject"],
      "Resource": ["arn:aws:s3:::bucket-name/output/*"]
    }
  ]
}
```

### 8.2 認証方式
- AWS CLI認証情報
- IAMロール（EC2/ECS実行時）

---

## 9. 運用仕様

### 9.1 実行方法

#### Jupyter Notebook
```bash
jupyter notebook
# notebooks/csv_compare_s3.ipynb を開いて実行
```

#### セル実行順序
1. セル1: ライブラリインポート
2. セル2: 設定
3. セル3: S3操作関数定義
4. セル4: 比較処理関数定義
5. セル5: ファイル一覧取得
6. セル6: 比較実行
7. セル7: 結果サマリー

### 9.2 ログ出力

**標準出力**:
- 処理開始/終了メッセージ
- ファイルサイズ情報
- 差分件数サマリー
- 進捗バー（tqdm）

**出力例**:
```
S3バケット: k-ishibashi-test
PrefixA: data/before/
PrefixB: data/after/

=== sample.csv ===
ファイルサイズ: PrefixA=0.1MB, PrefixB=0.1MB, 合計=0.2MB
通常処理を実行します...
差分: 5件
  ADDED: 1件
  DELETED: 1件
  MODIFIED: 3件
出力: s3://k-ishibashi-test/output/sample_diff_20250122_120000.csv
```

---

## 10. 保守・拡張性

### 10.1 今後の拡張予定

| 項目 | 優先度 | 説明 |
|------|--------|------|
| 並列処理対応 | 中 | 複数ファイルの同時処理 |
| リトライ機能 | 中 | ネットワークエラー時の自動リトライ |
| 統計レポート | 低 | 差分統計の詳細レポート |
| 進捗通知 | 低 | SNS/Slackへの通知機能 |

### 10.2 既知の制約

1. **大容量ファイル対応**: 実装済み（チャンク処理）
2. **並列処理未対応**: 複数ファイルは順次処理
3. **エラーハンドリング**: リトライ機能なし
4. **進捗表示**: 大容量ファイル時のみtqdm表示

---

## 11. バージョン情報

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-01-22 | 初版リリース |

---

## 12. 参考資料

### 12.1 依存ライブラリ
- pandas >= 1.5.0
- boto3 >= 1.26.0
- tqdm >= 4.64.0
- jupyter >= 1.0.0

### 12.2 関連ドキュメント
- README.md: 使用方法
- requirements.txt: 依存関係
- .gitignore: Git管理対象外ファイル
